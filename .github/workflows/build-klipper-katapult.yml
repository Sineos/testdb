name: Build Klipper and Katapult

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'settings/*.json'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup cache
      uses: actions/cache@v3
      with:
        path: ci_cache
        key: ${{ runner.os }}-build-${{ hashFiles('scripts/ci-install.sh') }}

    - name: Prepare tests
      run: ./scripts/ci-install.sh
      shell: bash

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Checkout Klipper repository
      run: |
        git clone https://github.com/Klipper3d/klipper.git klipper
      shell: bash

    - name: Checkout Katapult repository
      run: |
        git clone https://github.com/Arksine/katapult.git katapult
      shell: bash

    - name: Get changed JSON files
      id: get_json_files
      run: |
        # Get the list of changed files in the pull request
        CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep 'settings/*.json')
        echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV
      shell: bash

    - name: Process each changed JSON file for Klipper
      run: |
        for JSON_FILE in $CHANGED_FILES; do
          echo "Processing $JSON_FILE for Klipper"
          node scripts/ci-prepare_config.js "$JSON_FILE" klipper

          # Run build script
          chmod +x scripts/ci-build_klipper_katapult.sh
          ./scripts/ci-build_klipper_katapult.sh klipper

          # Check build status
          if [ $? -ne 0 ]; then
            echo "Build failed for $JSON_FILE in Klipper!"
            exit 1
          fi
        done
      shell: bash
      env:
        CHANGED_FILES: ${{ env.CHANGED_FILES }}

    - name: Process each changed JSON file for Katapult
      run: |
        for JSON_FILE in $CHANGED_FILES; do
          echo "Processing $JSON_FILE for Katapult"
          node scripts/ci-prepare_config.js "$JSON_FILE" katapult

          # Run build script
          chmod +x scripts/ci-build_klipper_katapult.sh
          ./scripts/ci-build_klipper_katapult.sh katapult

          # Check build status
          if [ $? -ne 0 ]; then
            echo "Build failed for $JSON_FILE in Katapult!"
            exit 1
          fi
        done
      shell: bash
      env:
        CHANGED_FILES: ${{ env.CHANGED_FILES }}
